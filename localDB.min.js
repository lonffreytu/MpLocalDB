var localDB,_dirty=!1;function _write(){_dirty=!0,setTimeout(()=>{_dirty&&(_dirty=!1,wx.setStorage({data:localDB,key:"localDB"}))},200)}function _update(t,o){for(var i in o)t[i]="function"==typeof o[i]?o[i](t[i]):o[i]}function Collection(t,o,i){this.data=t,this.options=i||{orderBy:[]},this.root=o||t}function Command(t){this.exec=t}Collection.prototype.add=function(t){var o=t._id||"";if("object"!=typeof t||this.data[o])return null;for((t=JSON.parse(JSON.stringify(t)))._id=void 0;!o||this.data[o];)for(var i=0;i<4;i++)o+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[parseInt(62*Math.random())];return this.data[o]=t,_write(),o},Collection.prototype.doc=function(o){var i=this.data[o];return i?{get:()=>{var t=JSON.parse(JSON.stringify(i));return t._id=o,t},update:t=>"object"==typeof t&&(_update(i,t),_write(),!0),remove:()=>!(this.data[o]=void 0)}:null},Collection.prototype.where=function(t){var o,i=(t,o)=>{for(var i in t){var n="_id"==i?o:this.data[o][i];if(t[i]instanceof Command||t[i]instanceof RegExp){if(!t[i].exec(n))return!1}else if(t[i]!=n)return!1}return!0},n={};for(o in this.data)if(this.data[o])if("or"==t.type){for(var e=0;e<t.arr.length;e++)if(i(t.arr[e],o)){n[o]=this.data[o];break}}else i(t,o)&&(n[o]=this.data[o]);return new Collection(n,this.root,this.options)},Collection.prototype.limit=function(t){var o=JSON.parse(JSON.stringify(this.options));return o.limit=t,new Collection(this.data,this.root,o)},Collection.prototype.skip=function(t){var o=JSON.parse(JSON.stringify(this.options));return o.skip=t,new Collection(this.data,this.root,o)},Collection.prototype.orderBy=function(t,o="asc"){var i=JSON.parse(JSON.stringify(this.options));return i.orderBy.push({field:t,order:o}),new Collection(this.data,this.root,i)},Collection.prototype.count=function(){var t,o=0;for(t in this.data)this.data[t]&&o++;return o},Collection.prototype.get=function(){var t,o,i=[],n=t=>{var o=this.data[t];o&&((o=JSON.parse(JSON.stringify(o)))._id=t,i.push(o))};if(this.options.orderBy.length){for(var e in this.data)n(e);i.sort((t,o)=>{for(var i=0;r=this.options.orderBy[i];i++){var n=t[r.field],e=o[r.field],r="desc"===r.order;if(null==n&&null!=e)return r?1:-1;if(null==e&&null!=n)return r?-1:1;if(null!=n&&null!=e)if("string"==typeof n&&"string"==typeof e){var a=n.localeCompare(e);if(0!==a)return(r?-1:1)*a}else if(n!==e)return(r?1:-1)*(n<e?1:-1)}return 0}),this.options.skip&&(i=i.slice(this.options.skip)),this.options.limit&&(i=i.slice(0,this.options.limit))}else for(o in this.data){if((!this.options.skip||t>=this.options.skip)&&(n(o),t+1-(this.options.skip||0)==this.options.limit))break;t++}return i},Collection.prototype.update=function(t){if("object"!=typeof t)return!1;for(var o in this.data)_update(this.data[o],t);return _write(),!0},Collection.prototype.remove=function(){for(var t in this.data)this.root[t]=void 0;_write()},Command.prototype.and=function(o){return new Command(t=>this.exec(t)&&o.exec(t))},Command.prototype.or=function(o){return new Command(t=>this.exec(t)||o.exec(t))},module.exports={init(){localDB=localDB||wx.getStorageSync("localDB")||{}},createCollection(t){return localDB?!localDB[t]&&(localDB[t]={},_write(),new Collection(localDB[t])):(console.warn("请先初始化"),!1)},removeCollection(t){if(!localDB)return console.warn("请先初始化");localDB[t]=void 0,_write()},collection(t){return localDB?localDB[t]?new Collection(localDB[t]):null:(console.warn("请先初始化"),!1)},command:{eq:o=>new Command(t=>t==o),neq:o=>new Command(t=>t!=o),lt:o=>new Command(t=>t<o),lte:o=>new Command(t=>t<=o),gt:o=>new Command(t=>o<t),gte:o=>new Command(t=>o<=t),in:o=>new Command(t=>o.includes(t)),nin:o=>new Command(t=>!o.includes(t)),exists:o=>new Command(t=>null==t?!o:o),or:(...t)=>({type:"or",arr:t[0]instanceof Array?t[0]:t}),set:t=>JSON.parse(JSON.stringify(t)),remove:()=>{},inc:o=>t=>t+o,mul:o=>t=>t*o,push:o=>t=>(t.push(o),t),pop:()=>t=>(t.pop(),t),shift:()=>t=>(t.shift(),t),unshift:o=>t=>(t.unshift(o),t)}};